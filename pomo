#!/usr/bin/env bash
# pomo
# bash 4+ pls

# much code lifted from dylanaraps' fff
# and lots of their pure-bash-bible

# default config
work_time=1500
break_time=300
long_break_time=1800
work_time_cycle=4
s=("working" "smol break" "long break" "stopped")

load_config () {
	dir="~/.config"
	dir="${dir/#\~/$HOME}"

	if test -f ${dir}/pomo/pomo.conf ; then
		. ${dir}/pomo/pomo.conf
	fi
}

get_term_size () {
	read -r LINES COLUMNS < <(stty size)
}

setup_terminal () {
	# set up the terminal for the TUI
	# \e[?1049h  use alternative screen buffer
	# \e[?7l     disable line wrapping
	# \e[?25l    hide the cursor
	# \e[2J      clear the screen
	# \e[1;Nr    limit scrolling to scrolling area
	#            also sets cursor to (0,0)
	printf '\e[?1049h\e[?7l\e[?25l\e[2J\e[1;%sr' "$max_items"

	# hide echoing of user input
	stty -echo
}

reset_terminal () {
	# reset the terminal to a useable state (undo all changes)
	# \e[?7h     re-enable line wrapping
	# \e[?25h    unhide the cursor
	# \e[2J      clear the terminal
	# \e[;r      set the scroll region to its default value
	#            also sets cursor to (0,0)
	# \e[?1049l  restore main screen buffer
	printf '\e[?7h\e[?25h\e[2J\e[;r\e[?1049l'

	# show user input
	stty echo
}

clear_screen () {
	# only clear the scrolling window (dir item list)
	# \e[%sH    move cursor to bottom of scroll area
	# \e[9999C  move cursor to right edge of the terminal
	# \e[1J     clear screen to top left corner (from cursor up)
	# \e[2J     clear screen fully (if using tmux) (fixes clear issues)
	# \e[1;%sr  clearing the screen resets the scroll region(?) Reset it
	#           also sets cursor to (0,0).
	printf '\e[%sH\e[9999C\e[1J%b\e[1;%sr' \
		   "$((LINES-2))" "${TMUX:+\e[2J}" "$max_items"
}

redraw () {
	clear_screen

	# print time
	printf "%02d:%02d\n" "$[timer/60]" "$[timer%60]"

	# print mode
	# @incomplete read from list in conf
	printf "$test"
	printf "$mode"
}

keypress () {
	# check for key events
	if ((mode<3)); then
		read -t 1 -n 1 key
	else
		read -n 1 key
	fi

	# parse key events
	# @incomplete replace with switch
	case $key in
		q)
			exit
		;;

		p)
			# toggle between modes
			[ $mode = 3 ] && mode=1 || mode=3
		;;
	esac
}

main () {
	# print version with -v
	[[ $1 == -v ]] && {
		printf '%s\n' "pomo 0.2.0"
		exit
	}

	# trap exit signal with a reset
	trap 'reset_terminal' EXIT

	# trap window resize
	trap 'get_term_size; redraw' WINCH

	load_config
	get_term_size
	setup_terminal

	# init timer
	timer=$work_time
	mode=1

	# initial draw
	redraw

	while true
	do
		# exit if terminal is killed
		[[ -t 1 ]] || exit 1

		keypress

		timer=$[timer-1]

		if ((timer<0)); then
			if ((mode==1)); then
				timer=$break_time
				mode=2
			elif ((mode==2)); then
				timer=$work_time
				mode=1
			fi
		fi

		redraw

		# sleep 1
	done
}

main "$@"
